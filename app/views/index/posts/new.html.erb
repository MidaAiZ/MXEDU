<!-- page heading start-->
<div class="page-heading">
    <ul class="breadcrumb">
        <li>
            <a href="javascript:void(0)" class='pull-left' role='back'><<取消</a>
        </li>
        <li>
            <a href="#">发表新贴</a>
        </li>
    </ul>
</div>
<!-- page heading end-->
<%= render "form" %>
<% unless @user.nickname %>
    <div aria-hidden="true" aria-labelledby="infoModalLabel" role="dialog" tabindex="-1" id="infoModal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-body">
                <%= form_tag user_path(@user), method: :patch, class: "form-signin", id: "info-form" do %>
                    <!-- <div class="form-signin-heading text-center">
                        <h1 class="sign-title">用户登录</h1>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <img src="/assets/index/login-logo.png" alt=""/>
                    </div> -->
                    <div class="login-wrap">
                        <p>初来乍到，取个行走江湖的名字吧<i class='fa fa-rocket' style="color: #ff6d6d"></i></p>
                        <input type="text" id="user_nick_input" name='user[nickname]' class="form-control" placeholder="hello world">
                        <div id="err"></div>
                        <button class="btn btn-lg btn-login btn-block" type="submit" id="submit-info">
                            <i class="fa fa-check"></i>
                        </button>
                    </div>
                <% end %>
            </div>
        </div>
    </div>
    <script>
        $(function() {
            setTimeout(function() {
                $("#infoModal").modal({
                    'show': true,
                    'keyboard': false
                })
                $(".modal").unbind("click");
            }, 300)
        })

        $("#info-form").submit(function(e) {
            e.preventDefault();
            var nick = $("#user_nick_input").val();
            if (!nick) { alert("请输入昵称"); return false}
            if (nick.length > 16) { alert("昵称名过长（不超过16个字符）"); return false }
            $.ajax({
                url: $(this).attr("action"),
                type: "PATCH",
                dataType: "JSON",
                data: {
                    index_user: {
                        nickname: $("#user_nick_input").val()
                    }
                },
                success: function() {
                    $("#infoModal").modal('hide');
                },
                error: function(err) {
                    if (JSON.parse(err.responseText).nickname) {
                        $("#err").html("<span style='color: red'><i class='fa fa-exclamation-circle'></i>该昵称已被占用</span>")
                    }
                },
                complete: function() {
                }
            })
            return false;
        })
    </script>
<% end %>
